# This document describes how to configure a Byton factory server.
# 
# You should have received it as part of the file factory-infra.<version>.tar.gz. 
# 
# To proceed you must be familiar with linux command line operation and common
# utilities as well as text editing, and should also have access to a workstation
# with ssh and scp. Presumably you're reading this file on that workstation.
#
# Note that lines that do not start with '#' are intended to be entered on the
# command line.
# 
# The server runs Debian Linux. Start by downloading an ISO install image, e.g.
# https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-9.9.0-amd64-netinst.iso.
# 
# Assuming the server can boot from USB, dd the image onto a USB stick.
# (Otherwise you'll have to create a CD/DVD.)
# 
# Attach keyboard, display and ethernet to server. Mouse is not required. The
# network must supply DHCP and internet access. 
# 
# The server mmust have two ethernet ports, whichever one you plug into will
# become the factory-facing interface. The other one will but the DUT interface,
# connected to test stations.
# 
# ### Mark the ports so you know which is which when it comes time to install the
# ### server in the factory.
# 
# If the server supports hardware RAID 1 you may need to enable it in system
# BIOS, not in scope of this document. But bear in mind that it may not be
# possible for linux to monitor the health of a hardware raid array and the
# system won't be physically accessible in normal operation.
# 
# The server does not require graphics, if possible the memory allocated for GPU
# should be adjusted to minimum size in the BIOS.
# 
# Install Debian:
# 
#   Boot the server from the prepared USB stick (or CD/DVD).
# 
#   When the menu appears, select "Install", NOT "Graphical Install". (Use the
#   tab key to sequence through text menus.)
# 
#   Select the default for language, keyboard, etc.
# 
#   Set hostname to "factory" 
# 
#   Set domain to "localdomain"
# 
#   Set root password to "u0+Y8". (Password strength is not super important
#   since the only access to the system will be via ssh keys). 
# 
#   Create a user named "factory" with password "factory"
# 
#   If the hard disk has an existing format you will be asked if you wish to
#   retain it, or wish the bootloader to support it. Say no.
# 
#   Select partitioning method "Guided - use entire disk"
# 
#   Select "All files in one paritition". (Do NOT enable disk encryption.)
# 
#   Select an appropriate source repo. Configure proxy if necessary.
# 
#   If asked about package survey, say no.
# 
#   When prompted for desktop environment do not select one, only select "SSH
#   Server" and "Standard Utilities".
# 
# Software install will proceed automatically. When done you will be prompted
# to remove the install media and reboot.
# 
# The system will boot to text login prompt. Log in as "factory".  
#     
# Check network interfaces:    
    
    ifconfig -a

# This should list two interfaces (besides lo). The inteface names are
# hardware-specific, for example "eno1" and "eno2". One of the interfaces will
# Have an IPV4 address which was assigned by DHCP, this is the factory
# interface.  The other will not, this is the DUT interface. 

# Make a note of the interface names and the current IP address.
# 
# Transfer the factory-infra tarball from your workstation to the server, for
# example using:
# 
#   you@yourpc:~$ scp factory-infra.<version>.tar.gz factory@ip.ad.re.ss:
# 
# At this point you may also want to "ssh factory@ip.ad.re.ss" from your
# workstation if that's more convenient than using the server's terminal.)
# 
# On the server, verify that the factory-infra tarball is in the right place:

    ls ~/factory-infra.*.tar.gz

# Become root:

    su -

# Install packages of interest, reply 'yes' or 'ok' to all prompts:

    apt install apache2 arping curl elinks htop iptables-persistent mlocate
    apt install net-tools postgresql psmisc python-psycogreen sudo sysstat
    apt install tcpdump tmux vim
    apt install --no-install-recommends dnsmasq

# Upack the factory-infra files:

    mv ~factory/factory-infra.*.tar.gz .
    tar -xzf factory-infra.*.tar.gz 
    chown -R root: factory-infra

# Install files from factory-infra into the root:

    factory-infra/server/install.sh

# Using vi or nano, edit /etc/factory/config and change "factory_interface=" and
# "dut_inteface=" lines to have the correct interface names. Make sure those
# lines do not have any spaces.

# Verify the configuration:

    source /etc/factory/config
    echo "Factory interface is '$factory_interface', DUT interface is '$dut_interface'"

# Configure etc/issue:

    sed -i s/XXXX/$factory_interface/g /etc/issue

# Configure the DUT interface: 

    sed -i s/XXXX/$dut_interface/g /etc/network/interfaces.d/factory.conf
    ifup $dut_interface
    ifconfig  

# You should see that the DUT interface now has address 172.16.240.254.

# Configure postgresql:

    su -lc "psql -f /etc/factory/schema.txt" postgres 

# Configure Apache:

    a2enmod cgi
    a2ensite default-ssl

# Configure iptables:

    ~/iptables.sh

# Config dnsmasq:

    /usr/lib/cgi-bin conf.dnsmasq

# Finally, reboot 
    
    reboot

# After reboot, ssh will require the factory rsa key. Copy the file
# factory-infra/insecure_factory_rsa_id to some path ion your home directory,
# and use:
#
#  ssh -i /path/to/insecure_factory_rsa_id factory@ip.ad.re.ss

# NOTE: in production, the insecure ssh and ssl keys must be replaced with
# secure keys. These are are highly confidential and distributed in encrypted
# form, contact Byton test engineering for details.
    




