This document describes how to configure a Byton factory server.

To proceed you must be familiar with linux command line operation and common
utilities, and should also have access to a workstation with ssh and scp.
(Presumably you're reading this file on that workstation.)

The server runs Debian Linux. Start by downloading an ISO install image, e.g.
https://cdimage.debian.org/debian-cd/current/amd64/iso-cd/debian-9.9.0-amd64-netinst.iso.

Assuming the server can boot from USB, dd the image onto a USB stick.
(Otherwise you'll have to create a CD/DVD.)

Attach keyboard, display and ethernet to server. Mouse is not required. The
network must supply DHCP and internet access. 

The server mmust have two ethernet ports, whichever one you plug into will
become the factory-facing interface. The other one will but the DUT interface,
connected to test stations.

* Mark the ports so you know which is which when it comes time to install the
* server in the factory.

If the server supports hardware RAID 1 you may need to enable it in system
BIOS, not in scope of this document. Bear in mind that it may not be
possible for linux to monitor the health of a hardware raid array and the
system won't be physically accessible in normal operation.

The server does not require graphics, if BIOS shows memory allocated for GPU it
can be set to minimum size.

Install Debian:

    Boot the server from the prepared USB stick (or CD/DVD). This may require
    entering BIOS and selecting the boot device. 

    When the Debian install menu appears, press down arrow and select
    "Install".  Do not select "Graphical Install". 

    Select the default for language, country, keymap, and network.

    Set hostname to "factory". 

    Set domain name to "localdomain".

    Set root password to "u0+Y8". (Password strength is not super important
    since the only access to the system will be via ssh keys). 

    Leave the full name for new user blank.

    Set the username to "factory", with password "factory".

    Set the default time zone (it will be changed to UCT later).

    If the hard disk has an existing non-UEFI bootloader you will be asked if
    you want to continue to use it. You do not.

    Select partitioning method "Guided - use entire disk"

    Select the hard drive to be partitioned (probably "sda", but this may be
    different if hardware raid is enabled).

    Select "All files in one paritition".

    Select "Write changes to disk".

    You will be informed that the hard drive is about to be "destroyed" with
    three new partitions. Select "Yes".

    Wait several minutes while the base system is installed.

    Select "United States".
    
    Select "ftp.us.debian.org". 

    Enter proxy information if necessary, but note the proxy will need to be
    disabled once the server is installed in the factory.

    Wait several more minutes.

    When asked about "popularity-contest", select "No".

    When prompted for "Software selection" make sure only "SSH server" and
    "standard system utilities" are starred, then press enter. Do NOT select a
    desktop environment.

    Wait several more minutes.

    Finally the "Installation complete" screen will appear. Remove install
    media and hit enter.

The system will reboot. When the "factory login:" prompt appears, log in as
"factory" (password "factory"). 
    
Check network interfaces:    
    
    > ip a

(Note the use of '>' in this document indicates a command to be entered.)

This should list two interfaces (besides "lo"). The inteface names are
hardware-specific, for example "eno1" and "eno2". One of the interfaces will
Have an "inet" address which was assigned by DHCP, this is the factory interface.
The other will not have an address, this is the DUT interface. 

Make a note of the interface names and the current IP address.

On your workstation, transter the "server" directory in the factory-infra repo
to the server:

    you@yourpc$ scp -r /path/to/factory-infra/server factory@ip.ad.re.ss:

At this point you may also want to "ssh factory@ip.ad.re.ss" from your
workstation if that's more convenient than using the server's console.

On the server, become root (password "u0+Y8"):

    > su - 

Run the install script as shown below, but replace "FACTORY" and "DUT" with the
names of the network interfaces you noted earlier:

    > ~factory/server/install.sh FACTORY DUT

This script will generate quite a bit of output, finally ending with "Install
complete". If you are asked any questions select "Yes". If the script exits
with an error message, capture the output and send to Byton test engineering.  

Reboot the system.
    
    > reboot

After reboot, note the IP address of the two interfaces will appear on the
login screen.

Using the factory IP address, browse to https://ip.ad.re.ss and you'll get a
certificate error. Add an exception (only on firefox?) to access the "Factory
Server" page.

To use ssh/scp you must provide the rsa key: 

    you@yourpc$ ssh -i /path/to/insecure_factory_rsa_id factory@ip.ad.re.ss

The ssh key passphase is "insecure".

################################### NOTE ###################################   

This process installs insecure (publicly-accessible) ssh and ssl keys by
default, to allow preliminary configuration and testing. The keys must be
replaced with secure keys prior to deploying the server into the factory, these
are distributed separately in encrypted form. 

This process also assumes that the factory does not use the 172.16.240.*
subnet, and it is therefore free to be used on the DUT interface. If that's not
true (i.e. the factory DOES use 172.16.240.*) then an alternative install
procedure is required which includes reconfiguration of test station
controllers.
